pipeline {
    agent any

    stages {

        stage('Récupération du code de la branche') {
            steps {
                git branch: 'master', url: 'https://github.com/AchrafBouslama/SopraHRProject.git'
            }
        } 
        
        stage("MAVEN BUILD") {
          steps {
            dir('backoffice') {

            sh 'mvn clean install -Dmaven.test.skip=true'
                              }
        }


    }




     stage("MOCKITO") {
              steps {
              dir('backoffice') {
                sh "mvn test -Dtest=com.example.achref.UserProfileServiceTest"
              }}
            }


 stage('SonarQube') {
            steps {
                 dir('backoffice') {
                // Provide SonarQube authentication using the provided token
                withCredentials([string(credentialsId: 'ParkWiseHR', variable: 'SONAR_TOKEN')]) {
                    sh "mvn sonar:sonar -Dsonar.login=$SONAR_TOKEN"
                }
                 }
            }
        }


      stage('Publish Artifacts to Nexus') {
                    steps {
                       dir('backoffice') {

                        script {
                            nexusArtifactUploader artifacts: [[
                                artifactId: 'SopraHRWork',
                                classifier: '',
                                file: 'target/SopraHRWork-0.0.1-SNAPSHOT.jar',
                                type: 'jar']],
                                credentialsId: 'nexusCredentials',
                                groupId: 'com.example',
                                nexusUrl: '192.168.4.13:8081',
                                nexusVersion: 'nexus3',
                                protocol: 'http',
                                repository: 'ParkWiseHR/',
                                version: '1.0'
                        }
                    }
                }
                }



        stage("BUILD DOCKER IMAGE") {
                    steps {
                          dir('backoffice') {

                      sh 'docker build -t achrafbouslama/newimage:latest .'
                    }}
                  }
              stage('docker push'){
                               steps{
                                     dir('backoffice') {
                                   script{
                                       sh 'docker login -u "achrafbouslama" -p "e181JMT2239#" docker.io'
                                       sh 'docker push achrafbouslama/newimage:latest'

                                   }
                               }
                           }}

                      stage('docker compose') {
                          steps{
                                dir('backoffice') {
                              sh 'docker compose up -d'
                          }}
                      }







}
}
